---
- name: Install prerequisites
  apt:
    name: [openjdk-17-jdk, apt-transport-https, openssl]
    state: present

- name: Ensure keyrings directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: 0755

- name: Download Elastic GPG key to keyrings
  get_url:
    url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
    dest: /etc/apt/keyrings/elastic.gpg
    mode: '0644'

- name: Add Elastic repository (new keyring method)
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/elastic.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main"
    state: present
    filename: elastic-8.x

- name: Install Elasticsearch
  apt:
    name: elasticsearch
    state: present
    update_cache: yes

- name: Create certs directory
  file:
    path: /etc/elasticsearch/certs
    state: directory
    owner: root
    group: elasticsearch
    mode: 0750

- name: Ensure Elasticsearch log directory exists and is writable
  file:
    path: /usr/share/elasticsearch/logs
    state: directory
    owner: elasticsearch
    group: elasticsearch
    mode: 0755

- name: Ensure Elasticsearch data directory exists and is writable
  file:
    path: /var/lib/elasticsearch
    state: directory
    owner: elasticsearch
    group: elasticsearch
    mode: 0755

- name: Stop Elasticsearch if running (to apply config changes)
  systemd:
    name: elasticsearch
    state: stopped
  ignore_errors: yes

- name: Generate CA private key
  command: openssl genrsa -out /etc/elasticsearch/certs/ca.key 4096
  args:
    creates: /etc/elasticsearch/certs/ca.key

- name: Generate CA certificate
  command: openssl req -x509 -new -nodes -key /etc/elasticsearch/certs/ca.key -sha256 -days 3650 -subj "/CN=EDR-CA" -out /etc/elasticsearch/certs/ca.crt
  args:
    creates: /etc/elasticsearch/certs/ca.crt

- name: Generate Elasticsearch private key
  command: openssl genrsa -out /etc/elasticsearch/certs/elasticsearch.key 4096
  args:
    creates: /etc/elasticsearch/certs/elasticsearch.key

- name: Generate Elasticsearch CSR
  command: openssl req -new -key /etc/elasticsearch/certs/elasticsearch.key -subj "/CN={{ ansible_fqdn | default(ansible_hostname) }}" -out /etc/elasticsearch/certs/elasticsearch.csr
  args:
    creates: /etc/elasticsearch/certs/elasticsearch.csr

- name: Sign Elasticsearch certificate with CA
  command: openssl x509 -req -in /etc/elasticsearch/certs/elasticsearch.csr -CA /etc/elasticsearch/certs/ca.crt -CAkey /etc/elasticsearch/certs/ca.key -CAcreateserial -out /etc/elasticsearch/certs/elasticsearch.crt -days 365 -sha256
  args:
    creates: /etc/elasticsearch/certs/elasticsearch.crt

- name: Set permissions on certs
  file:
    path: /etc/elasticsearch/certs
    owner: root
    group: elasticsearch
    mode: 0750
    recurse: yes

- name: Configure Elasticsearch
  template:
    src: elasticsearch.yml.j2
    dest: /etc/elasticsearch/elasticsearch.yml
    owner: root
    group: elasticsearch
    mode: 0660
  notify: restart elasticsearch

- name: Start and enable service
  systemd:
    name: elasticsearch
    state: started
    enabled: yes
  register: elasticsearch_start_result
  failed_when: false

- name: Check Elasticsearch status if startup failed
  shell: systemctl status elasticsearch
  register: elasticsearch_status_output
  when: elasticsearch_start_result is failed
  failed_when: false

- name: Display Elasticsearch status if failed
  debug:
    msg: "{{ elasticsearch_status_output.stdout_lines }}"
  when: elasticsearch_start_result is failed

- name: Check Elasticsearch logs if startup failed
  shell: journalctl -xeu elasticsearch.service --no-pager | tail -20
  register: elasticsearch_logs_output
  when: elasticsearch_start_result is failed
  failed_when: false

- name: Display Elasticsearch logs if failed
  debug:
    msg: "{{ elasticsearch_logs_output.stdout_lines }}"
  when: elasticsearch_start_result is failed

- name: Fail with clear error message
  fail:
    msg: "Elasticsearch failed to start. Check the logs above for the specific error."
  when: elasticsearch_start_result is failed

- name: Wait for Elasticsearch to be ready
  uri:
    url: "https://localhost:9200"
    method: GET
    validate_certs: no
    status_code: 200
  register: elasticsearch_health
  until: elasticsearch_health.status == 200
  retries: 30
  delay: 10
  ignore_errors: yes

- name: Verify Elasticsearch is running
  systemd:
    name: elasticsearch
    state: started
  register: elasticsearch_status

- name: Fail if Elasticsearch is not running
  fail:
    msg: "Elasticsearch failed to start. Check logs with: sudo journalctl -xeu elasticsearch.service"
  when: elasticsearch_status.status.ActiveState != "active"

- name: Check if elasticsearch-setup-passwords has already been run
  stat:
    path: /etc/elasticsearch/passwords_set.flag
  register: passwords_flag

- name: Run elasticsearch-setup-passwords auto and capture output
  command: /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b
  register: setup_passwords_output
  changed_when: "'Changed password for user [elastic]' in setup_passwords_output.stdout"
  when:
    - elasticsearch_start_result is not failed
    - not passwords_flag.stat.exists
  ignore_errors: yes

- name: Create flag file after password setup
  file:
    path: /etc/elasticsearch/passwords_set.flag
    state: touch
  when:
    - elasticsearch_start_result is not failed
    - setup_passwords_output is defined
    - setup_passwords_output.rc == 0
    - not passwords_flag.stat.exists

- name: Extract elastic user password from setup-passwords output
  set_fact:
    elastic_auto_password: "{{ setup_passwords_output.stdout | regex_search('PASSWORD elastic = (.+)', '\\1') }}"
  when:
    - setup_passwords_output is defined
    - setup_passwords_output.stdout is defined
    - setup_passwords_output.rc == 0

- name: Print Elasticsearch credentials (if just set)
  debug:
    msg: |
      Elasticsearch is ready!
      Username: elastic
      Password: {{ elastic_auto_password | default('UNKNOWN - see setup-passwords output above') }}
  when:
    - elasticsearch_start_result is not failed
    - setup_passwords_output is defined
    - setup_passwords_output.rc == 0

- name: Print message if passwords already set
  debug:
    msg: |
      Elasticsearch passwords have already been set. If you need the elastic password, see your previous deployment output or reset manually.
  when:
    - passwords_flag.stat.exists
    - (setup_passwords_output is not defined) or (setup_passwords_output.rc != 0) 

- name: Save elastic credentials to file
  copy:
    dest: /etc/elasticsearch/elastic-credentials.txt
    content: |
      Username: elastic
      Password: {{ elastic_auto_password | default('UNKNOWN - see setup-passwords output above') }}
    owner: root
    group: root
    mode: '0600'
  when:
    - elastic_auto_password is defined
    - elastic_auto_password != '' 

- name: Print final instructions for credentials
  debug:
    msg: |
      âœ… EDR Backend deployment complete!
      
      To generate or reset your login credentials for Elasticsearch, Kibana, and TheHive, run:
        sudo ./generate-edr-credentials.sh
      
      Your credentials will be printed and saved to /etc/elasticsearch/edr-credentials.txt
      
      Access your services:
        - Elasticsearch: https://localhost:9200
        - Kibana:       https://localhost:5601
        - TheHive:      https://localhost:9000
      
      For more help, see the README or contact your administrator. 